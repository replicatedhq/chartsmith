
build:
  chartsmith-worker:
    context: .
    dockerfile: ./hack/worker/Dockerfile.okteto
  chartsmith-migrations:
    context: .
    dockerfile: ./hack/migrations/Dockerfile.okteto
  chartsmith-app:
    context: .
    dockerfile: ./hack/app/Dockerfile.okteto

deploy:
  - envsubst < kustomize/worker/overlays/dev/deployment.tmpl.yaml > kustomize/worker/overlays/dev/deployment.yaml
  - envsubst < kustomize/app/overlays/dev/deployment.tmpl.yaml > kustomize/app/overlays/dev/deployment.yaml
  - envsubst < kustomize/app/overlays/dev/secret.tmpl.yaml > kustomize/app/overlays/dev/secret.yaml

  - cd kustomize/overlays/dev && kustomize edit set image chartsmith-worker=${OKTETO_BUILD_CHARTSMITH_WORKER_IMAGE}
  - cd kustomize/overlays/dev && kustomize edit set image chartsmith-app=${OKTETO_BUILD_CHARTSMITH_APP_IMAGE}
  - cd kustomize/overlays/dev && kustomize edit set image migrations=${OKTETO_BUILD_CHARTSMITH_MIGRATIONS_IMAGE}

  - kustomize build kustomize/overlays/dev

  - kubectl apply -k kustomize/overlays/dev

dev:
  chartsmith-worker:
    command: make okteto-dev && bash || bash
    workdir: /go/src/github.com/replicatedhq/chartsmith
    sync:
      - ./:/go/src/github.com/replicatedhq/chartsmith
  chartsmith-migrations:
    command: bash
    workdir: /go/src/github.com/replicatedhq/chartsmith/db
    sync:
      - ./db:/go/src/github.com/replicatedhq/chartsmith/db
    environment:
      SCHEMAHERO_DRIVER: postgres
      SCHEMAHERO_SPEC_FILE: /go/src/github.com/replicatedhq/chartsmith/db/schema/tables
      SCHEMAHERO_URI: "postgresql://chartsmith:password@chartsmith-postgres/chartsmith?connect_timeout=10&application_name=chartsmith&sslmode=disable"
      SCHEMAHERO_SEED_DATA: "true"
  chartsmith-app:
    command: bash
    workdir: /app
    sync:
      - ./chartsmith-app:/app
