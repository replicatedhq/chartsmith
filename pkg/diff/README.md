# Diff Handling in Chartsmith

This package contains code for handling diffs in Chartsmith, particularly for reconstructing and correcting diffs that may be imperfect, such as those generated by LLMs.

## Features

- **Fuzzy matching** for finding the correct line positions in files
- **Indentation handling** to preserve the original file's whitespace 
- **Multiple similarity metrics** for better context line matching:
  - Character-by-character comparison
  - Token-based comparison
  - Indentation-aware comparison
- **Fallback strategies** for imperfect diffs:
  - Handling missing or incorrect line numbers
  - Handling improper indentation
  - Handling out-of-order hunks
- **Self-healing patches** that work even when LLM-generated diffs are not perfect

## Testing

We have comprehensive tests covering various edge cases:
- Basic diff functionality
- Special case handling (Chart.yaml, etc.)
- Multi-hunk diffs
- Out-of-order hunks
- Improper indentation
- Missing line numbers
- Minimal context
- YAML indentation specifics
- Real-world complex examples

## Frontend Integration

The Chartsmith frontend includes complementary diff handling in the CodeEditor component and patch.ts implementation:
- Context-based position matching
- Handling out-of-order hunks
- Tracking offset for proper application of sequential hunks
- Robust error handling that gracefully handles malformed patches
- Improved hunk detection and parsing
- Fuzzy matching to find the best position for changes

## Recent Improvements

We've made several enhancements to the patch application system:

1. **Backend Go code**:
   - Added fuzzy matching for context lines
   - Improved indentation handling
   - Added support for malformed hunks
   - Better handling of out-of-order hunks

2. **Frontend TypeScript code**:
   - Enhanced patch preprocessing in acceptPatchAction
   - Added robust error handling to prevent failures
   - Improved fuzzy line matching with multiple similarity metrics
   - Better hunk parsing that can recover from malformed headers
   - Support for applying patches without proper headers
   - More resilient patch application that continues even if some hunks fail

## Design Principles

We've focused on:
1. **Robustness** - handle a wide variety of diff formats and imperfections
2. **Correctness** - apply patches in the right places, even with minimal context
3. **Preservation** - maintain original file structure and formatting
4. **Fuzzy Matching** - find the right position even when line numbers are incorrect
5. **Graceful Degradation** - make best effort to apply changes even with imperfect input

This approach creates a resilient system that can handle the challenges of working with LLM-generated patches while maintaining a high success rate for patch application.